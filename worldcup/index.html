<!doctype html>
<html>
    <head>
        <meta charset="utf-8">

        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-120894276-1"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'UA-120894276-1');
        </script>

        <title>World Cup 2018 Sweepstake</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link rel="shortcut icon" href="favicon.ico" />
        <style>
            * {
                font-family: sans-serif;
                color: #ccc;
            }

            body {
                background-color: #111;
            }

            .container {
                max-width: 840px;
                margin: 0 auto;
            }

            .match-header, .groups-header {
                margin-bottom: 8px;
            }

            .match .team {
                margin-left: 0;
                margin-right: 0;
            }

            .match .score {
                font-weight: bold;
            }

            table {
                border-collapse: collapse;
            }

            table.player-table {
                table-layout: fixed;
                width: 100%;
            }

            table.player-table tbody td:nth-child(1) {
                width: 40%;
            }

            table.player-table tbody td:nth-child(2) {
                width: 60%;
            }

            table.group-table {
                width: 100%;
            }

            @media only screen and (max-width: 400px) {
                table.group-table .hide-column {
                    display: none;
                }
            }

            .group-table-container {
                width: 50%;
                display: inline-block;
                box-sizing: border-box;
                padding: 8px;
            }

            @media only screen and (max-width: 840px) {
                .group-table-container {
                    width: 100%;
                    padding: 8px 0;
                }
            }

            th, td {
                border: 1px solid #333;
                padding: 8px;
                text-align: left;
            }

            .unallocated-teams {
                margin-top: 16px;
            }

            .team {
                display: inline-block;
                background-color: #333;
                border-radius: 4px;
                padding: 4px;
                white-space: nowrap
            }

            .team-spaced {
                margin: 4px;
            }

            .team.knocked-out {
                text-decoration: line-through;
                background-color: #222;
                color: #999;
            }

            .team .flag {
                height: 16px;
                border-radius: 4px;
            }
            .team.knocked-out .flag {
                filter: brightness(25%)
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.min.js"></script>
    </head>
    <body>
        <div id="app"></div>

        <script type="x-vue-template" id="team-badge-template">
            <div class="team" :class="{'knocked-out': team && team.knocked_out}">
                <template v-if="team">
                    {{ team.name }}
                    <span v-if="show_person">
                        <template v-if="person">
                            ({{ person.name }})
                        </template>
                        <template v-else>
                            (N/A)
                        </template>
                    </span>
                    <img :src="team.flag_url" class="flag">
                </template>
                <template v-else>
                    n/a
                </template>
            </div>
        </script>

        <script type="x-vue-template" id="match-template">
            <div class="match">
                <template v-if="match">
                    <team-badge
                        :team="teams_by_code[match.home_team.code] || null"
                        :person="team_code_to_person[match.home_team.code]"
                        class="team-spaced"
                    />
                    <span v-if="show_scores" class="score">
                        {{ match.home_team.goals }}
                    </span>
                    <template v-if="show_scores">â€“</template><template v-else>vs</template>
                    <span v-if="show_scores" class="score">
                        {{ match.away_team.goals }}
                    </span>
                    <team-badge
                        :team="teams_by_code[match.away_team.code] || null"
                        :person="team_code_to_person[match.away_team.code]"
                        class="team-spaced"
                    />
                    <div class="match-kickoff"><small>{{ formatted_kickoff_time }} (uk time)</small></div>
                </template>
                <p v-else-if="loading">
                    loading...
                </p>
                <p v-else>
                    n/a
                </p>
            </div>
        </script>

        <script type="x-vue-template" id="group-table-template">
            <div class="group-table-container">
                <table class="group-table">
                    <thead>
                        <tr>
                            <th colspan="6">Group {{ group.code }}</th>
                        </tr>
                        <tr>
                            <th>Team</th>
                            <th class="hide-column">W</th>
                            <th class="hide-column">D</th>
                            <th class="hide-column">L</th>
                            <th class="hide-column">GD</th>
                            <th>Pts</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="team in group.teams">
                            <td>
                                <team-badge :team="teams_by_code[team.code] || null"
                                            :person="team_code_to_person[team.code]"
                                            class="team-spaced"
                                />
                            </td>
                            <td class="hide-column">{{ team.group_stats.wins }}</td>
                            <td class="hide-column">{{ team.group_stats.draws }}</td>
                            <td class="hide-column">{{ team.group_stats.losses }}</td>
                            <td class="hide-column">
                                <template v-if="team.get_group_goal_difference() >= 0">+</template>{{ team.get_group_goal_difference() }}
                            </td>
                            <td>{{ team.get_group_points() }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </script>

        <script type="x-vue-template" id="app-template">
            <div class="container">
                <h1>World Cup 2018 Sweepstake</h1>

                <h2 class="match-header">
                    Next Match
                </h2>
                <match :match="next_match"
                       :loading="!matches"
                       :teams_by_code="teams_by_code"
                       :team_code_to_person="team_code_to_person" />

                <h2 class="match-header">
                    Last Match
                </h2>
                <match :match="last_match"
                       :loading="!matches"
                       :teams_by_code="teams_by_code"
                       :team_code_to_person="team_code_to_person" />

                <h2>Players and Teams</h2>
                <table class="player-table">
                    <tbody>
                        <tr v-for="person in people_with_teams">
                            <td class="player">{{ person.name }}</td>
                            <td>
                                <team-badge v-for="team in person.teams" :key="team.code"
                                    :team="team" :show_person="false"
                                    class="team-spaced"
                                />
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="unallocated-teams">
                    <team-badge v-for="team in unallocated_teams":key="team.code"
                        :team="team" :show_person="false"
                        class="team-spaced"
                    />
                </div>

                <h2 class="groups-header">Groups</h2>
                <group-table v-for="group in groups":key="group.code"
                            :group="group" :teams_by_code="teams_by_code" :team_code_to_person="team_code_to_person"/>

                <p><strong>Good luck!</strong> ðŸ¤‘</p>
            </div>
        </script>

        <script>
            function Person(name, teams) {
                this.name = name;
                this.teams = teams;
            }

            function Team(code, name, group, knocked_out) {
                this.code = code;
                this.name = name;
                this.group = group;
                this.knocked_out = knocked_out;
                this.flag_url = "flags/" + this.code.toLowerCase() + ".gif";

                this.group_stats = {
                    goals_scored: 0,
                    goals_conceded: 0,
                    wins: 0,
                    draws: 0,
                    losses: 0
                }
            }

            Team.prototype.get_group_points = function() {
                return (this.group_stats.wins * 3) + (this.group_stats.draws);
            }

            Team.prototype.get_group_played = function() {
                return this.group_stats.wins + this.group_stats.draws + this.group_stats.losses;
            }

            Team.prototype.get_group_goal_difference = function() {
                return this.group_stats.goals_scored - this.group_stats.goals_conceded;
            }

            Vue.component('team-badge', {
                template: '#team-badge-template',
                props: {
                    'team': Object,
                    'person': Object,
                    'show_person': {
                        type: Boolean,
                        default: true
                    }
                }
            });

            Vue.component('match', {
                template: '#match-template',
                props: {
                    'match': Object,
                    'loading': Boolean,
                    'teams_by_code': Object,
                    'team_code_to_person': Object
                },
                computed: {
                    show_scores: function() {
                        if (!this.match) { return false; }
                        return this.match.status == 'in progress' || this.match.status == 'completed'
                    },
                    formatted_kickoff_time: function() {
                        if (!this.match) { return null; }
                        function pad2(n) {
                            return (n < 10 ? "0" : "") + n;
                        }
                        var months = ['January', 'February', 'March', 'April', 'May', 'June',
                                       'July', 'August', 'September', 'October', 'November', 'December'];
                        var t = new Date(this.match.datetime);
                        return months[t.getMonth()] + " " +
                               t.getDate() + " " +
                               + pad2(t.getHours()) + ":" + pad2(t.getSeconds())
                    }
                }
            });

            Vue.component('group-table', {
                template: '#group-table-template',
                props: {
                    'group': Object,
                    'teams_by_code': Object,
                    'team_code_to_person': Object
                }
            });

            var app = new Vue({
                el: '#app',
                template: '#app-template',
                data: function() {
                    var teams = [
                        new Team('ARG',     'Argentina',    'D',    false),
                        new Team('AUS',     'Australia',    'C',    false),
                        new Team('BEL',     'Belgium',      'G',    false),
                        new Team('BRA',     'Brazil',       'E',    false),
                        new Team('COL',     'Colombia',     'H',    false),
                        new Team('CRC',     'Costa Rica',   'E',    false),
                        new Team('CRO',     'Croatia',      'D',    false),
                        new Team('DEN',     'Denmark',      'C',    false),
                        new Team('EGY',     'Egypt',        'A',    false),
                        new Team('ENG',     'England',      'G',    false),
                        new Team('FRA',     'France',       'C',    false),
                        new Team('GER',     'Germany',      'F',    false),
                        new Team('ISL',     'Iceland',      'D',    false),
                        new Team('IRN',     'Iran',         'B',    false),
                        new Team('JPN',     'Japan',        'H',    false),
                        new Team('MEX',     'Mexico',       'F',    false),
                        new Team('MAR',     'Morocco',      'B',    false),
                        new Team('NGA',     'Nigeria',      'D',    false),
                        new Team('PAN',     'Panama',       'G',    false),
                        new Team('PER',     'Peru',         'C',    false),
                        new Team('POL',     'Poland',       'H',    false),
                        new Team('POR',     'Portugal',     'B',    false),
                        new Team('RUS',     'Russia',       'A',    false),
                        new Team('KSA',     'Saudi Arabia', 'A',    false),
                        new Team('SEN',     'Senegal',      'H',    false),
                        new Team('SRB',     'Serbia',       'E',    false),
                        new Team('KOR',     'South Korea',  'F',    false),
                        new Team('ESP',     'Spain',        'B',    false),
                        new Team('SWE',     'Sweden',       'F',    false),
                        new Team('SUI',     'Switzerland',  'E',    false),
                        new Team('TUN',     'Tunisia',      'G',    false),
                        new Team('URU',     'Uruguay',      'A',    false)
                    ];
                    var people = [
                        new Person('Andrew C.',     ['MEX', 'SUI']),
                        new Person('Andrew E.',     ['BRA', 'FRA']),
                        new Person('Anna S.',       ['COL', 'ISL']),
                        new Person('David H.',      ['GER', 'SWE']),
                        new Person('Freyja W.',     ['CRO', 'DEN']),
                        new Person('John M.',       ['CRC', 'NGA']),
                        new Person('Patrick G.',    ['AUS', 'ESP']),
                        new Person('Ryan S.',       ['JPN', 'KOR']),
                        new Person('Sam D.',        ['EGY', 'POR']),
                        new Person('Sam W.',        ['RUS', 'URU']),
                        new Person('Scott B.',      ['MAR', 'KSA'])
                    ];

                    return {
                        teams: teams,
                        people: people,
                        group_match_pivot: new Date('2018-06-28T22:00Z'),
                        matches: null
                    }
                },
                created: function() {
                    var self = this,
                        req = new XMLHttpRequest();
                    req.addEventListener("load", function(e) {
                        self.load_matches(JSON.parse(this.responseText));
                    });
                    req.open("GET", "https://world-cup-json.herokuapp.com/matches/?by_date=asc");
                    req.send();
                },
                methods: {
                    load_matches: function(matches) {
                        var self = this;
                        self.matches = matches;

                        var completed_group_matches = this.matches.filter(function(m) {
                            return m.status == 'completed' && new Date(m.datetime) < self.group_match_pivot;
                        });

                        completed_group_matches.forEach(function(match) {
                            var home_team = self.teams_by_code[match.home_team.code],
                                away_team = self.teams_by_code[match.away_team.code];
                            if (!home_team || !away_team) { return; }

                            home_stats = home_team.group_stats;
                            away_stats = away_team.group_stats;

                            if (match.home_team.goals > match.away_team.goals) {
                                home_stats.wins++;
                                away_stats.losses++;
                            } else if (match.home_team.goals < match.away_team.goals) {
                                home_stats.losses++;
                                away_stats.wins++;
                            } else {
                                home_stats.draws++;
                                away_stats.draws++;
                            }

                            home_stats.goals_scored += match.home_team.goals;
                            away_stats.goals_scored += match.away_team.goals;

                            home_stats.goals_conceded += match.away_team.goals;
                            away_stats.goals_conceded += match.home_team.goals;
                        });
                    }
                },
                computed: {
                    people_with_teams: function() {
                        var teams_by_code = {};
                        this.teams.forEach(function(team) {
                            teams_by_code[team.code] = team;
                        });

                        return result = this.people.map(function(person) {
                            return {
                                'name': person.name,
                                'teams': person.teams.map(function(team_code) {
                                    return teams_by_code[team_code];
                                })
                            }
                        });
                        return result;
                    },
                    unallocated_teams: function() {
                        var allocated_team_codes = this.people.map(function(person) {
                            return person.teams;
                        }).reduce(function(a, b) { return a.concat(b); }, []);
                        return result =  this.teams.filter(function(team) {
                            return allocated_team_codes.indexOf(team.code) == -1;
                        });
                    },
                    teams_by_code: function() {
                        var teams = {};
                        this.teams.forEach(function(team) {
                            teams[team.code] = team;
                        });
                        return teams;
                    },
                    team_code_to_person: function() {
                        var teams = {};
                        this.people.forEach(function(p) {
                            p.teams.forEach(function(t) {
                                teams[t] = p;
                            });
                        });
                        return teams;
                    },
                    groups: function() {
                        var self = this,
                            groups = {}
                        this.teams.forEach(function(team) {
                            if (!groups[team.group]) {
                                groups[team.group] = {
                                    code: team.group,
                                    teams: []
                                };
                            }
                            groups[team.group].teams.push(team);
                        });

                        groups = Object.values(groups);
                        groups.sort(function(a, b) {
                            if (a.code < b.code) return -1;
                            if (a.code > b.code) return 1;
                            return 0;
                        });

                        groups.forEach(function(group) {
                            group.teams.sort(function(a, b) {
                                // Sort by points
                                var a_points = a.get_group_points(),
                                    b_points = b.get_group_points();
                                if (a_points > b_points) return -1;
                                if (b_points < b_points) return 1;

                                // Then by goal difference.
                                var a_gd = a.get_group_goal_difference(),
                                    b_gd = b.get_group_goal_difference()
                                if (a_gd > b_gd) return -1;
                                if (a_gd < b_gd) return 1;

                                // Then by goals scored.
                                if (a.group_stats.goals_scored > b.group_stats.goals_scored) return -1;
                                if (a.group_stats.goals_scored < b.group_stats.goals_scored) return 1;

                                // Then by name.
                                if (a.name < b.name) return -1;
                                if (a.name > b.name) return 1;
                                return 0;
                            });
                        });

                        return groups;
                    },
                    next_match: function() {
                        if (this.matches) {
                            var now = new Date();
                            for (var i = 0; i < this.matches.length; i++) {
                                if (this.matches[i].status != 'completed') {
                                    return this.matches[i];
                                }
                            }
                        }
                        return null;
                    },
                    last_match: function() {
                        if (!this.matches) { return null }
                        var now = new Date();
                        for (var i = 0; i < this.matches.length - 1; i++) {
                            if (this.matches[i].status != 'completed') {
                                if (i <= 0) { return null; }
                                return this.matches[i - 1];
                            }
                        }
                        return this.matches[this.matches.length - 1];
                    }
                }
            })
        </script>
    </body>
</html>
