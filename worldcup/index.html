<!doctype html>
<html>
    <head>
        <meta charset="utf-8">

        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-120894276-1"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'UA-120894276-1');
        </script>

        <title>World Cup 2018 Sweepstake</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link rel="shortcut icon" href="favicon.ico" />
        <style>
            * {
                font-family: sans-serif;
                color: #ccc;
            }

            body {
                background-color: #111;
            }

            .container {
                max-width: 800px;
                margin: 0 auto;
            }

            table {
                table-layout: fixed;
                width: 100%;
                border-collapse: collapse;
            }

            th, td {
                border: 1px solid #333;
                padding: 8px;
                text-align: left;
            }

            tbody td:nth-child(1) {
                width: 40%;
            }

            tbody td:nth-child(2) {
                width: 60%;
            }

            .unallocated-teams {
                margin-top: 16px;
            }

            .team {
                display: inline-block;
                background-color: #333;
                border-radius: 4px;
                padding: 4px;
                white-space: nowrap
            }

            .team-spaced {
                margin: 4px;
            }

            .team.knocked-out {
                text-decoration: line-through;
                background-color: #222;
                color: #999;
            }

            .team .flag {
                height: 16px;
                border-radius: 4px;
            }
            .team.knocked-out .flag {
                filter: brightness(25%)
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
    </head>
    <body>
        <div id="app"></div>

        <script type="x-vue-template" id="template">
            <div  class="container">
                <h1>World Cup 2018 Sweepstake</h1>

                <h2>Next Match</h2>
                <template v-if="matches && next_match">
                    <p>
                        <div class="team">
                            {{ teams_by_code[next_match.home_team.code].name }}
                            ({{ team_code_to_person[next_match.home_team.code].name }})
                            <img :src="teams_by_code[next_match.home_team.code].flag_url" class="flag">
                        </div>
                        vs.
                        <div class="team">
                            {{ teams_by_code[next_match.away_team.code].name }}
                            ({{ team_code_to_person[next_match.away_team.code].name }})
                            <img :src="teams_by_code[next_match.away_team.code].flag_url" class="flag">
                        </div>
                    </p>
                </template>
                <p v-else-if="!matches">
                    loading...
                </p>
                <p v-else>
                    no more matches, it's all over!
                </p>

                <h2>Last Match</h2>
                <template v-if="matches && last_match">
                    <p>
                        <div class="team">
                            {{ teams_by_code[last_match.home_team.code].name }}
                            ({{ team_code_to_person[last_match.home_team.code].name }})
                            <img :src="teams_by_code[last_match.home_team.code].flag_url" class="flag"/>
                        </div>
                        vs.
                        <div class="team">
                            {{ teams_by_code[last_match.away_team.code].name }}
                            ({{ team_code_to_person[last_match.away_team.code].name }})
                            <img :src="teams_by_code[last_match.away_team.code].flag_url" class="flag"/>
                        </div>
                    </p>
                </template>
                <p v-else-if="!matches">
                    loading...
                </p>
                <p v-else>
                    no matches have been played yet!
                </p>

                <h2>Players and Teams</h2>
                <table>
                    <tbody>
                        <tr v-for="person in people_with_teams">
                            <td class="player">{{ person.name }}</td>
                            <td>
                                <div v-for="team in person.teams"
                                    class="team team-spaced" :class="{'knocked-out': team.knocked_out}">
                                    {{ team.name }} <img :src="team.flag_url" class="flag"/>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="unallocated-teams">
                    <div v-for="(team, index) in unallocated_teams"
                            class="team team-spaced">
                        {{ team.name }} <img :src="team.flag_url" class="flag"/>
                    </div>
                </div>

                <p><strong>Good luck!</strong> ðŸ¤‘</p>
            </div>
        </script>

        <script>
            function Person(name, teams) {
                this.name = name;
                this.teams = teams;
            }

            function Team(code, name, group, knocked_out) {
                this.code = code;
                this.name = name;
                this.group = group;
                this.knocked_out = knocked_out;
                this.flag_url = "flags/" + this.code.toLowerCase() + ".gif";
            }

            var app = new Vue({
                el: '#app',
                template: '#template',
                data: function() {
                    var teams = [
                        new Team('ARG',     'Argentina',    'D',    false),
                        new Team('AUS',     'Australia',    'C',    false),
                        new Team('BEL',     'Belgium',      'G',    false),
                        new Team('BRA',     'Brazil',       'E',    false),
                        new Team('COL',     'Colombia',     'H',    false),
                        new Team('CRC',     'Costa Rica',   'E',    false),
                        new Team('CRO',     'Croatia',      'D',    false),
                        new Team('DEN',     'Denmark',      'C',    false),
                        new Team('EGY',     'Egypt',        'A',    false),
                        new Team('ENG',     'England',      'G',    false),
                        new Team('FRA',     'France',       'C',    false),
                        new Team('GER',     'Germany',      'F',    false),
                        new Team('ISL',     'Iceland',      'D',    false),
                        new Team('IRN',     'Iran',         'B',    false),
                        new Team('JPN',     'Japan',        'H',    false),
                        new Team('MEX',     'Mexico',       'F',    false),
                        new Team('MAR',     'Morocco',      'B',    false),
                        new Team('NGA',     'Nigeria',      'D',    false),
                        new Team('PAN',     'Panama',       'G',    false),
                        new Team('PER',     'Peru',         'C',    false),
                        new Team('POL',     'Poland',       'H',    false),
                        new Team('POR',     'Portugal',     'B',    false),
                        new Team('RUS',     'Russia',       'A',    false),
                        new Team('KSA',     'Saudi Arabia', 'A',    false),
                        new Team('SEN',     'Senegal',      'H',    false),
                        new Team('SRB',     'Serbia',       'E',    false),
                        new Team('KOR',     'South Korea',  'F',    false),
                        new Team('ESP',     'Spain',        'B',    false),
                        new Team('SWE',     'Sweden',       'F',    false),
                        new Team('SUI',     'Switzerland',  'E',    false),
                        new Team('TUN',     'Tunisia',      'G',    false),
                        new Team('URU',     'Uruguay',      'A',    false)
                    ];
                    var people = [
                        new Person('Andrew C.',     ['MEX', 'SUI']),
                        new Person('Andrew E.',     ['BRA', 'FRA']),
                        new Person('Anna S.',       ['COL', 'ISL']),
                        new Person('David H.',      ['GER', 'SWE']),
                        new Person('Freyja W.',     ['CRO', 'DEN']),
                        new Person('John M.',       ['CRC', 'NGA']),
                        new Person('Patrick G.',    ['AUS', 'ESP']),
                        new Person('Ryan S.',       ['JPN', 'KOR']),
                        new Person('Sam D.',        ['EGY', 'POR']),
                        new Person('Sam W.',        ['RUS', 'URU']),
                        new Person('Scott B.',      ['MAR', 'KSA'])
                    ];
                    var match_length = 120 * 60 * 1000;

                    return {
                        teams: teams,
                        people: people,
                        match_length: match_length,
                        matches: null
                    }
                },
                created: function() {
                    var self = this,
                        req = new XMLHttpRequest();
                    req.addEventListener("load", function(e) {
                        self.matches = JSON.parse(this.responseText);
                    });
                    req.open("GET", "https://world-cup-json.herokuapp.com/matches/");
                    req.send();
                },
                computed: {
                    people_with_teams: function() {
                        var teams_by_code = {};
                        this.teams.forEach(function(team) {
                            teams_by_code[team.code] = team;
                        });

                        return result = this.people.map(function(person) {
                            return {
                                'name': person.name,
                                'teams': person.teams.map(function(team_code) {
                                    return teams_by_code[team_code];
                                })
                            }
                        });
                        return result;
                    },
                    unallocated_teams: function() {
                        var allocated_team_codes = this.people.map(function(person) {
                            return person.teams;
                        }).reduce(function(a, b) { return a.concat(b); }, []);
                        return result =  this.teams.filter(function(team) {
                            return allocated_team_codes.indexOf(team.code) == -1;
                        });
                    },
                    teams_by_code: function() {
                        var teams = {};
                        this.teams.forEach(function(team) {
                            teams[team.code] = team;
                        });
                        return teams;
                    },
                    team_code_to_person: function() {
                        var teams = {};
                        this.people.forEach(function(p) {
                            p.teams.forEach(function(t) {
                                teams[t] = p;
                            });
                        });
                        return teams;
                    },
                    next_match: function() {
                        if (this.matches) {
                            var now = new Date();
                            for (var i = 0; i < this.matches.length; i++) {
                                if (this.match_end_time(this.matches[i].datetime) > now) {
                                    return this.matches[i];
                                }
                            }
                        }
                        return null;
                    },
                    last_match: function() {
                        if (!this.matches) { return null }
                        var now = new Date();
                        for (var i = 0; i < this.matches.length - 1; i++) {
                            if (this.match_end_time(this.matches[i].datetime) > now) {
                                if (i <= 0) { return null; }
                                return this.matches[i - 1];
                            }
                        }
                        return this.matches[this.matches.length - 1];
                    }

                },
                methods: {
                    match_end_time: function(start_time) {
                        return new Date(new Date(start_time) + this.match_length);
                    }
                }
            })
        </script>
    </body>
</html>
